"""
EXPERIMENT: EXP-056
Date: 2025-11-17
Objective: Deploy production-ready daily signal scanner with automated reporting

MOTIVATION:
Research phase COMPLETE - all major parameters optimized!
- 45 stocks optimized (all 70%+ WR)
- Dynamic position sizing deployed (+41.7%)
- All parameters validated (EXP-052 through EXP-055)
- Strategy performing at theoretical maximum
- Time to shift from RESEARCH to PRODUCTION DEPLOYMENT

CURRENT GAP:
- Signal scanner exists but runs manually
- No automated daily scanning
- No email alerts when signals trigger
- No performance tracking over time
- Missing real-time deployment of optimized strategy

SOLUTION:
Production signal scanner that:
- Runs daily automatically (scheduled)
- Scans all 45 stocks for signals
- Sends email alert with signal details
- Tracks historical performance
- Generates daily performance report
- Ready for live trading deployment

EXPECTED OUTCOME:
- Automated daily signal detection
- Email alerts within minutes of market close
- Historical performance tracking
- Production-ready trading system
- Seamless transition from backtest to live trading
"""

import sys
import os
import pandas as pd
import json
from datetime import datetime, timedelta

sys.path.insert(0, os.path.abspath(os.path.join(os.path.dirname(__file__), '../..')))

from src.trading.ml_signal_scanner import MLSignalScanner
from src.notifications.sendgrid_notifier import SendGridNotifier


def format_signal_email(signals: list, market_regime: str) -> str:
    """
    Format signals for email alert.

    Returns:
        HTML-formatted email body
    """
    if not signals:
        return f"""
<html>
<body>
<h2>Proteus Daily Scan - {datetime.now().strftime('%Y-%m-%d')}</h2>

<p><strong>Market Regime:</strong> {market_regime}</p>

<p><strong>Signals Found:</strong> None</p>

<p>No mean reversion signals detected today across 45-stock universe.</p>

<p><em>Scanned: 45 stocks | v15.0-EXPANDED | 79.3% avg win rate</em></p>
</body>
</html>
"""

    signal_rows = ""
    for signal in signals:
        ml_prob = signal.get('ml_probability', 0.0)
        ml_conf = signal.get('ml_confidence', 'N/A')

        # Color code ML confidence
        ml_color = '#28a745' if ml_conf == 'HIGH' else '#ffc107' if ml_conf == 'MEDIUM' else '#dc3545'

        signal_rows += f"""
<tr>
    <td><strong>{signal['ticker']}</strong></td>
    <td>${signal['price']:.2f}</td>
    <td>{signal['z_score']:.2f}</td>
    <td>{signal['rsi']:.1f}</td>
    <td>{signal['expected_return']:.1f}%</td>
    <td>{signal['signal_strength']:.0f}/100</td>
    <td>{signal['position_size']:.2f}x</td>
    <td style="background-color: {ml_color}; color: white; font-weight: bold;">{ml_prob:.3f} ({ml_conf})</td>
</tr>
"""

    return f"""
<html>
<body>
<h2>Proteus Daily Scan - {datetime.now().strftime('%Y-%m-%d')}</h2>

<p><strong>Market Regime:</strong> {market_regime}</p>

<p><strong>Signals Found:</strong> {len(signals)}</p>

<table border="1" cellpadding="5" cellspacing="0" style="border-collapse: collapse;">
<tr style="background-color: #f0f0f0;">
    <th>Ticker</th>
    <th>Price</th>
    <th>Z-Score</th>
    <th>RSI</th>
    <th>Expected Return</th>
    <th>Signal Strength</th>
    <th>Position Size</th>
    <th>ML Probability</th>
</tr>
{signal_rows}
</table>

<h3>Trade Parameters:</h3>
<ul>
    <li><strong>Entry:</strong> Market open or current price</li>
    <li><strong>Profit Target:</strong> +2.0% (Day 0), +1.5% (Day 1), +1.0% (Day 2+)</li>
    <li><strong>Stop Loss:</strong> -2.0%</li>
    <li><strong>Max Hold:</strong> 3 days</li>
    <li><strong>Position Sizing:</strong> Dynamic based on signal strength</li>
</ul>

<h3>Strategy Performance (v15.0-EXPANDED):</h3>
<ul>
    <li><strong>Portfolio:</strong> 45 stocks (all 70%+ win rate)</li>
    <li><strong>Win Rate:</strong> ~79.3% (validated on 3+ years)</li>
    <li><strong>Avg Return:</strong> ~19.2% per stock</li>
    <li><strong>Trade Frequency:</strong> ~251 trades/year</li>
    <li><strong>100% Win Rate Stocks:</strong> AVGO, TXN, JPM, ADI, NOW, ROAD, COP</li>
</ul>

<p><em>Generated by Proteus v15.0-EXPANDED | Fully optimized via EXP-047 through EXP-055</em></p>
</body>
</html>
"""


def save_daily_scan_results(signals: list, market_regime: str):
    """
    Save scan results to historical log.
    """
    results_dir = 'logs/daily_scans'
    os.makedirs(results_dir, exist_ok=True)

    scan_date = datetime.now().strftime('%Y-%m-%d')
    filename = f"scan_{scan_date}.json"
    filepath = os.path.join(results_dir, filename)

    scan_data = {
        'date': scan_date,
        'timestamp': datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
        'market_regime': market_regime,
        'signals_count': len(signals),
        'signals': signals
    }

    with open(filepath, 'w') as f:
        json.dump(scan_data, f, indent=2, default=str)

    print(f"Scan results saved to: {filepath}")


def run_exp056_production_scanner():
    """
    Run production daily signal scanner.
    """
    print("="*70)
    print("EXP-056: PRODUCTION SIGNAL SCANNER")
    print("="*70)
    print(f"Started: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print()

    print("Objective: Deploy production-ready daily signal scanner")
    print("System: v15.0-EXPANDED (fully optimized)")
    print("Portfolio: 45 stocks | 79.3% win rate | ~251 trades/year")
    print()

    # Initialize ML-enhanced scanner
    scanner = MLSignalScanner(lookback_days=60)

    # Check market regime
    print("Checking market regime...")
    market_regime = scanner.get_market_regime()
    print(f"Market regime: {market_regime}")
    print()

    if market_regime == 'BEAR':
        print("[ALERT] Market is in BEAR regime - Trading disabled!")
        print()

        # Send email notification
        notifier = SendGridNotifier()
        if notifier.is_enabled():
            notifier.send_scan_notification(
                scan_status=f"BEAR MARKET - Trading Disabled",
                signals=[],
                scanned_tickers=scanner.tickers
            )
            print("BEAR market notification sent via email")

        # Save scan results
        save_daily_scan_results([], market_regime)

        return {
            'date': datetime.now().strftime('%Y-%m-%d'),
            'market_regime': market_regime,
            'signals_count': 0,
            'signals': [],
            'trading_enabled': False
        }

    # Scan for signals
    print(f"Market is in {market_regime} regime - Scanning for signals...")
    print()

    signals = scanner.scan_all_stocks()

    print()
    print("="*70)
    print("SCAN RESULTS")
    print("="*70)
    print()

    print(f"Signals found: {len(signals)}")

    if signals:
        print()
        print("SIGNAL DETAILS:")
        print("-"*80)
        print(f"{'Ticker':<8} {'Price':<10} {'Z-Score':<10} {'RSI':<8} {'Exp.Ret':<10} {'Strength':<10} {'Size':<8} {'ML Prob':<10} {'ML Conf'}")
        print("-"*80)

        for signal in signals:
            ml_prob = signal.get('ml_probability', 0.0)
            ml_conf = signal.get('ml_confidence', 'N/A')
            print(f"{signal['ticker']:<8} "
                  f"${signal['price']:<9.2f} "
                  f"{signal['z_score']:<10.2f} "
                  f"{signal['rsi']:<8.1f} "
                  f"{signal['expected_return']:<9.1f}% "
                  f"{signal['signal_strength']:<9.0f}/100 "
                  f"{signal['position_size']:<7.2f}x "
                  f"{ml_prob:<9.3f} "
                  f"{ml_conf}")

    print()
    print("="*70)

    # Send email notification
    notifier = SendGridNotifier()
    if notifier.is_enabled():
        print("Sending email notification...")

        scan_status = f"{market_regime} market - {len(signals)} signals found"
        notifier.send_scan_notification(
            scan_status=scan_status,
            signals=signals,
            scanned_tickers=scanner.tickers
        )

        print("Email notification sent!")
    else:
        print("[INFO] Email not configured - skipping notification")

    # Save scan results
    save_daily_scan_results(signals, market_regime)

    # Return results
    return {
        'date': datetime.now().strftime('%Y-%m-%d'),
        'market_regime': market_regime,
        'signals_count': len(signals),
        'signals': signals,
        'trading_enabled': True
    }


if __name__ == '__main__':
    """Run production daily scanner."""

    print("\n[PRODUCTION SCANNER] Running daily signal scan")
    print("Strategy: v15.0-EXPANDED (fully optimized)")
    print("This will take 2-3 minutes...")
    print()

    results = run_exp056_production_scanner()

    print("\n" + "="*70)
    print("PRODUCTION SCANNER COMPLETE")
    print("="*70)
    print()

    if results['trading_enabled']:
        if results['signals_count'] > 0:
            print(f"[SUCCESS] {results['signals_count']} signals found and reported")
        else:
            print("[INFO] No signals today - market conditions not favorable")
    else:
        print("[ALERT] Trading disabled due to BEAR market")

    print()
